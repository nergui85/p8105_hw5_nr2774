---
title: "p8105_nr2774"
output: github_document
---

### Problem 1

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(dplyr)
library(rvest)
library(purrr)
library(ggplot2)
library(patchwork)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


### Problem 2

```{r setup, include=FALSE}

df = read_csv(file = "data_hw5/homicide-data.csv") |> 
    janitor::clean_names() |> 
    mutate(city_state = str_c(city, ",", state )) |>
    as.tibble()


```


```{r}
# reported date range 
pull(df,reported_date) |> 
  as.character() %>% 
  range()
#victim's age range
pull(df,victim_age) |> 
    as.character() |> 
    as.integer() |>  
    range(na.rm =TRUE)
```

#### Describe the raw data:
This data set contains `r nrow(df)` homicides records. Reported date range is from 20070101 to 20171231 and victim age range is from 0 to 102 years old. Other information such as victim`s name,race,sex and the location details and disposition state of these homicides were included in this data set. 

In order to check if the number of city_state matches with city.i run the folowoing code.

```{r collapse=TRUE}
#the number of city_state 
nrow(distinct(df,city_state))
# the number of cities
nrow(distinct(df,city))
#check the dataset and find the city "Tulsa" shows up in two states:
 filter(df,city == "Tulsa") |> 
     distinct(state)
```

Number of city_state were 51 whereas number of state was 50. It means there was an overlap with city names. After filtering, city "Tulsa" was recorded both in Oklahoma and Al. Therefore, Tulsa recorded under Al will be excluded from further data set.  
* Homocide 

```{r}
# Why there is still 51 variables ??
homicide_sum = df %>% 
    group_by(city_state) |> 
    summarise(total_homicides = n()) |> 
    filter(city_state != "Tulsa,AL")

```

* Creating homocide summary table 

```{r}
# Summarize within cities to obtain the total number of homicides and the number of unsolved homicides

homicide_sum = df %>% 
  #exclude "Tulsa, AL"
  group_by(city_state) %>% 
  mutate(
    unsolved = ifelse(disposition == "Closed by arrest",0,1)
      ) %>% 
  summarise(
    total_homicides = n(),
    unsolved_homicides = sum(unsolved)
  ) %>% 
  arrange(desc(total_homicides)) |> 
    subset(city_state != "Tulsa,AL")
homicide_sum %>% 
  knitr::kable() 
```

* Baltimore analysis

```{r setup, include=FALSE}
# Estimating the proportion of unsolved homicides in Baltimore, MD

baltimore_prop = 
  homicide_sum %>%
  filter(city_state == "Baltimore,MD")
 test_prop = prop.test(baltimore$unsolved_homicides, baltimore$total_homicides)
 
 test_prop %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)

```

* Iteration for all cities (proportion of unsolved homicides)

```{r}
# Estimating the proportion of unsolved homicides in all cities by applying iteration 
all_cities_proportion = 
  homicide_sum |> 
  mutate(
    tests_prop = purrr::map2(.x = unsolved_homicides, .y = total_homicides, ~prop.test(x = .x, n = .y)),
    tests_tidy = purrr::map(.x = tests_prop, ~broom::tidy(.x))
  ) |>  
  select(-tests_prop) |>  
  unnest(tests_tidy) |>  
  select(city_state, estimate, starts_with("conf"))

```


```{r}
all_cities_proportion |>  
  mutate(city_state = fct_inorder(city_state)) |>  
  ggplot(aes(x = city_state, y = estimate, fill = city_state)) + 
    geom_point() + geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
    theme(axis.text.x = element_text(angle = 90,size = 8)) +
  theme(legend.position = "none") +
  labs(x = "City",y = "Proportion Estimate",title = "Proportion Estimates for All Cities")
      
```





























